# docker-compose.yml (External MongoDB)
# Production Docker Compose setup for AI Email Sorter
# Uses external MongoDB URL (MongoDB Atlas, etc.)

version: '3.8'

services:
  # ==========================================
  # Express Backend Service
  # ==========================================
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: email-sorter-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      # Database - Use external MongoDB URL
      DATABASE_URL: ${DATABASE_URL}
      NODE_ENV: production
      PORT: 5000
      CLIENT_URL: ${CLIENT_URL}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      AI_MODEL: claude-sonnet-4-5
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE: 7d
      SESSION_SECRET: ${SESSION_SECRET}
      MAX_EMAILS_PER_SYNC: 50
      EMAIL_SYNC_INTERVAL: 3600000
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 100
    networks:
      - email-sorter-network
    healthcheck:
      test: curl -f http://localhost:5000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # React Frontend Service
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: email-sorter-frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      REACT_APP_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
    networks:
      - email-sorter-network
    healthcheck:
      test: wget --quiet --tries=1 --spider http://localhost:3000/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  email-sorter-network:
    driver: bridge

# No volumes needed - MongoDB is external